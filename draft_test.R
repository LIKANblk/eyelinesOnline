
require(Resonance)
require(eyelinesOnline)
require(hybridEyeEEG)

W = c(0.00385290513521772, -0.00370913931910223, 
      0.000635062869660534, 0.00142242410135533, -0.00381519454580514, 
      0.0015840679961306, 0.00677390042539757, -0.00107995447938261, 
      0.00490007134117828, -0.00139351230375762, 0.000763201204623465, 
      -0.00581633546507833, -0.00127832861215035, 0.00553240867112762, 
      0.00126624661797999, 0.00169058755375234, 0.00718170319907938, 
      -0.00210651406996413, 0.00519638531594951, -0.00390203979309791, 
      -0.00363641751019622, -0.00197687150019084, 0.000329251772942475, 
      -0.00071251759246043, 6.18454778962046e-05, -0.000440805729974299, 
      0.000755636981810333, -0.000997946355778557, -0.000552637765858128, 
      -0.00083541470144822, 0.00194009381279018, 2.58179905365948e-05, 
      -0.00041341113161893, -0.00213521614868781, -0.00403354264803787, 
      0.00151372046448131, -0.00254000761070296, -0.00194197043212391, 
      -0.00269348964185794, -0.00137825778849593, 0.000698995972537777, 
      0.00265315980804107, 0.000939743562017529, 0.00300420755544237, 
      0.00608103781652614, 0.000809092440245414, 0.00219120263225147, 
      0.00284244208490919, 0.00314329992469388, 0.00258338368272635, 
      -0.00126421058182349, 0.00275574092076524, 0.00189859554155075, 
      0.00210747994385548, 0.00623408019475577, -0.000184046108803407, 
      0.0034780523744696, 0.00359036015873337, 0.00375618948167707, 
      0.00369884211078873, -0.000230236543759818, 0.000472720563628404, 
      0.000358825949684857, 0.000225028824693016, 0.000868585687639008, 
      -2.76512306994666e-05, 0.000610490275043632, 0.000563470605329893, 
      0.0005900563830924, 0.000627255051400703)
th = -0.405776574260782 
ufeats = structure(c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 
                     2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 
                     4, 4, 4, 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 
                     6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 
                     7, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 
                     9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 
                     8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 
                     7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10), .Dim = c(70L, 
                                                                           2L))
channels = c(1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 14, 15, 16)
low = 0.1
high = 30
A1 = 13
A2 = 14
fixDur = 500
sRate = 500
t = 250
bsln_start = 20
bsln_end = 30



file = 'd:/YandexDisk/eyelinesOnline/data/test-first/02.r2e'
signal <- R3::extractChannel(file,0)
sync_marks <- which( diff(signal[,ncol(signal)])>0 )
signal <- signal[(sync_marks[3]+1):nrow(signal), ]

actions <- extract.actions('d:/YandexDisk/eyelinesOnline/data/test-first/24251775')
msgbuttonPressed_t <- ceiling(actions[which(actions$Type=="msgbuttonPressed"),1]*1E6)
msgev <- rep(T, length(msgbuttonPressed_t))

input1 <- source.channels(signal, samplingRate=500)
input2 <- source.events(msgev, msgbuttonPressed_t)

input <- function(x){
  if(x==1){ input1 }else{ input2 }
}

#eval(applyClassifier)


RM <- diag(nrow=33)[channels,]
FS <- pipeline(
  input(1),
  signalPreparation(, low=low, high=high, notch=50),
  pipe.spatial(, RM),
  pipe.references(, c(A1,A2))
)
#createOutput('niceEEG', FS)


RA1 <- pipe.decimate(FS, 1, 20 , coef_10000_to_500)
ev <- input(2)
RA2 <- cross.windowizeByEvents(RA1, ev, t/20, shift=-t/20)
RA3 <- pipe.medianWindow(RA2, 1, 12)
RA4 <- pipe.trof.classifier(RA3, W, th, ufeats )
RES <- ev[do.call(c,RA4)]
createOutput(RES,'RES')