W <-
  c(-0.00173814977605669, -0.000876403906414247, 0.00124423102655864, 
    -0.00510123282632479, -0.000555478979353333, -0.00323968025792718, 
    -0.00372182860895173, -0.000583368272054546, 0.000814531881320921, 
    -0.00646434086499669, -0.00247539979875256, -0.00218474359494594, 
    -0.00184205946148164, -0.00527709017213845, -0.00251046796009507, 
    -0.00259466906133818, -0.00241708910838375, -0.000438951340956837, 
    -7.67190932925001e-05, -0.00334176911745669, 0.0028317093240851, 
    0.000876907355959099, 0.0012259877862078, -0.00190465822310574, 
    0.0015347740889522, 0.000583102207414551, -0.00300063859314579, 
    0.00251213599260606, 0.00258004893457483, -0.000172594694762832, 
    0.00263040180224342, 0.00196859353592013, 0.00405419469243566, 
    -0.002325256003518, 0.00190358544752394, 0.000320379899044515, 
    -0.00015233320670346, 0.00179119066585063, 0.00313147934168527, 
    -0.00152474690730866, -0.000875097124104354, -0.00152445940824998, 
    0.00312292130673953, -0.00395789913491901, 0.000409529763672401, 
    -0.00266160833682498, 0.000982083448574972, -0.00154756126157219, 
    -0.000516059660180664, -0.000985551031565951, 0.000612722115695979, 
    0.00073586488507385, 0.00127062696161358, -0.00185600520516907, 
    0.00138595235113212, -0.000719180325864239, -0.00161825586158772, 
    0.000351451545340224, 5.7832612285417e-05, -0.000886257180939968, 
    0.00102911061041525, 0.000841564435495801, -0.000341080621832472, 
    -0.00200155194962247, 0.00156668904211207, -0.000293674556764973, 
    -0.00429050896820478, 0.00164004984422171, 0.00158032403945864, 
    -0.00130192666266722, 0.000812790130259136, 0.000361860461201383, 
    -0.000691564542731459, -0.00232720827542445, 0.00147237770369803, 
    -0.000569023939647216, -0.0047806254602592, 0.00156946349718499, 
    0.00169136981981217, -0.00140245647497194)
th <-
  0.221321612824468
ufeats <-
  structure(c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2, 
              2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 
              4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6, 6, 6, 6, 6, 
              6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 
              1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 
              1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 
              1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 
              1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10), .Dim = c(80L, 
                                                                                      2L))
A1 <-
  11
A2 <-
  12
fixDur <-
  800
sRate <-
  500
t <-
  400

RM <- diag(nrow=31)[1:12,]


input1 <- source.dataBlocks(RAW_EEG_BLOCKS, "channels", channels=32, samplingRate=500)
input2 <- source.dataBlocks(RAW_FIX_BLOCKS, "message")

ch <- signalPreparation(input1, 1, high=100) 
p0 <- pipe.spatial(ch, RM)
p1 <- pipe.references(p0, c(A1,A2)) 
p2 <- pipe.centering(p1, 500) 
p3 <- pipe.decimate(p2, 1, 20 , coef_10000_to_500) 
p4 <- cross.windowizeByEvents(p3, input2, t/20) 
p5 <- pipe.trof.classifier(p4, W, th, ufeats ) 
# out <- drain.debug(
#   pipeline(
#     signalPreparation(input1, 1, high=100),
#     pipe.spatial(ch, RM),
#     pipe.references(p0, c(A1,A2)),
#     pipe.centering(p1, 500),
#     pipe.decimate(p2, 1, 20 , coef_10000_to_500)
# #    cross.windowizeByEvents(p3, input2, t),
# #    pipe.trof.classifier(p4, W, th, ufeats ) 
#   )
# )
createOutput("doClick", p5)

p5$connect(function(data){
  cat("====>\n")
})

# debug(environment(input2$emit)$callback)
# debug(environment(p3$emit)$callback)

pumpTogether(input1, input2)
